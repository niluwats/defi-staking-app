{"ast":null,"code":"/**\n * Methods to fetch and decode reason string from ganache when a tx errors.\n */\nvar reason = {\n  /**\n   * Extracts a reason string from `eth_call` response\n   * @param  {Object}           res  response from `eth_call` to extract reason\n   * @param  {Web3}             web3 a helpful friend\n   * @param  {InterfaceAdapter}      interfaceAdapter a new helpful friend\n   * @return {String|Undefined}      decoded reason string\n   */\n  _extract: function _extract(res, web3, _interfaceAdapter) {\n    //I'm not sure why interfaceAdapter is here if it's not used,\n    //so I just put an underscore in front of its name for now...\n    if (!res || !res.error && !res.result) return;\n    var errorStringHash = \"0x08c379a0\";\n    var isObject = res && typeof res === \"object\" && res.error && res.error.data;\n    var isString = res && typeof res === \"object\" && typeof res.result === \"string\";\n\n    if (isObject) {\n      // NOTE that Ganache >=2 returns the reason string when\n      // vmErrorsOnRPCResponse === true, which this code could\n      // be updated to respect (instead of computing here)\n      var data = res.error.data;\n      var resData;\n\n      if (typeof data === \"string\") {\n        resData = data; // geth, Ganache >7.0.0\n      } else if (\"result\" in data) {\n        // there is a single result (Ganache 7.0.0)\n        resData = data.result;\n      } else {\n        // handle `evm_mine`, `miner_start`, batch payloads, and ganache 2.0\n        // NOTE this only works for a single failed transaction at a time.\n        var hash = Object.keys(data)[0];\n        var errorDetails = data[hash];\n        resData = errorDetails.return\n        /* ganache 2.0 */\n        ;\n      }\n\n      if (resData && resData.includes(errorStringHash)) {\n        try {\n          return web3.eth.abi.decodeParameter(\"string\", resData.slice(10));\n        } catch (_) {\n          return undefined;\n        }\n      }\n    } else if (isString && res.result.includes(errorStringHash)) {\n      try {\n        return web3.eth.abi.decodeParameter(\"string\", res.result.slice(10));\n      } catch (_) {\n        return undefined;\n      }\n    }\n  },\n\n  /**\n   * Runs tx via `eth_call` and resolves a reason string if it exists on the response.\n   * @param  {Object} web3\n   * @param  {Object} interfaceAdapter\n   * @return {String|Undefined}\n   */\n  get: function get(params, web3, interfaceAdapter) {\n    var packet = {\n      jsonrpc: \"2.0\",\n      method: \"eth_call\",\n      params: [params, \"latest\"],\n      id: new Date().getTime()\n    };\n    return new Promise(function (resolve) {\n      web3.currentProvider.send(packet, function (err, response) {\n        var reasonString = reason._extract(response, web3, interfaceAdapter);\n\n        resolve(reasonString);\n      });\n    });\n  }\n};\nmodule.exports = reason;","map":null,"metadata":{},"sourceType":"script"}